---
title: "Pasaulio statistika"
author: "Armintė Globytė"
date: 2015-07-23T21:13:14-05:00
categories: ["Pasaulis"]
tags: ["pasaulis","koronavirusas","COVID-19","statistika"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, collapse = TRUE, error = TRUE, warning = FALSE, message = FALSE)
```

```{r, include=FALSE}
# loading packets that are needed for running the .Rmd
source("./scripts/loading_R_packets.R")
source("./scripts/data_import_preparation_world.R")
```

```{r, include=FALSE}
# loading shape files
#source: 
shape <- readOGR("./shape_files/ne_50m_admin_0_sovereignty.shp",
                 encoding = "utf-8",
                 use_iconv = T,
                 verbose = FALSE,
                 stringsAsFactors = FALSE)%>%
  st_as_sf(countries)%>%
  select(SOVEREIGNT, POP_EST)%>%
  mutate(POP_EST=as.numeric(POP_EST))

# source: Eurostat
#EU_shape <- get_eurostat_geospatial(output_class = "sf", resolution = "60", nuts_level = "3")%>% filter(CNTR_CODE=="LT")
```


```{r, include=FALSE}

data_world <- read.csv("./data/data_world.csv",header = TRUE,stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date),
         var=factor(var, levels=c("confirmed", "recovered", "deaths")))

```


Statistika
* iš JHCSSE `r max(data_world$date)`


# Pasaulis - žemėlapiai

## Užsikrėtimai (/pop.)
```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="confirmed",
         date==max(date))

max.date <- max(df$date)

df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))%>%
  mutate(POP_EST=as.numeric(POP_EST))%>%
  mutate(value_pop=value/POP_EST*100000)

# summary(df$value_pop)
# min(df$value_pop,na.rm = T)
# max(df$value_pop,na.rm = T)

my_breaks <- c(1,10,100,1000,10000,100000)

ggplot(df, aes(fill=value_pop))+
  geom_sf()+
  ylim(-55,80)+
  xlim(-130,140)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
  labs(title=paste0("Atvejų skaičius tenkantis 100 000 gyventojų, ",max.date,""),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt")
```

## Nauji (proc. 14d)

Žemiau pateikiamas naujų registruotų atvejų skaičiaus santykinis pokytis (procentais) per paskutines 14 dienų. Šis žemėlapis iliustruoja aktyvius koronaviruso židinius pasaulyje.

```{r, echo=FALSE}
max.date <- max(data_world$date)

df <- data_world%>%
  filter(var=="confirmed",
         date==max(date)-14|date==max(date))%>%
  spread(date, value)%>%
  mutate(diff=round((.[,6]/.[,5]-1)*100,1))%>%
  filter(.[,5]>=10)%>% # to exclude inf as result of x/0
  select(1,4,7)%>%
  rename(value=diff)


df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))

#my_breaks <- c(min(df$value, na.rm = T), round(max(df$value, na.rm = T)*0.9))

ggplot(df, aes(fill=value))+
  geom_sf()+
  ylim(-55,80)+
  xlim(-130,140)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       #breaks=my_breaks,
                       #labels=my_breaks,
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100")+
  labs(title="Naujų atvejų proc. pokytis per paskutines 14 dienų",
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
       x="",
       y="")

```

# Užsikrėtimai

## Bendras skaičius

```{r, echo=FALSE}
df <- data_world %>%
  group_by(date, var)%>%
  summarise(value=sum(value)/1000000)

max.date <- max(df$date)

ggplot(df, aes(x=date, y=value, fill=var))+
  geom_area(alpha=0.6)+
  scale_fill_manual(values=c("red","green", "black"),
                    labels=c("Užsikrėtimai","Pasveikę","Mirę"))+
  scale_x_date(breaks="1 month", date_labels = "%Y-%m")+
  scale_y_continuous(labels = comma)+
  labs(title="Pasaulinis koronaviruso atvejų skaičius ir pasiskirstymas, mln.",
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
       x="Data",
       y="Skaičius")+
  theme(legend.title=element_blank(),
        legend.position='bottom',
        axis.text.x = element_text(angle = 45, hjust = 1))
```

## Užsikrėtimai (ts, top 5)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="confirmed")%>%
  spread(date, value)%>%
  arrange(desc(.[,ncol(.)]))%>%
  .[1:5,]%>%
  gather(date, value, 5:ncol(.))%>%
  mutate(date=as.Date(date),
         value=value/1000000)

ggplot(df, aes(x=date, y=value, color=valstybe, group=valstybe)) +
  geom_line(size=1.15)+
  scale_color_brewer(palette="Set1",type = "qualitative", name="Valstybės")+
  labs(
    title="Atvejų skaičius top 5 šalys, mln.",
    subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
    x="Laikotarpis",
    y="Užsikrėtimų skaičius")+
  scale_x_date(breaks="1 month", date_labels = "%Y-%m")+
  theme(axis.text=element_text(size=8),
        axis.text.x=element_text(angle=45, hjust=1))

```


## Užsikrėtimai (ts, top 6-16 vietos)
```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="confirmed")%>%
  spread(date, value)%>%
  arrange(desc(.[,ncol(.)]))%>%
  .[6:15,]%>%
  gather(date, value, 5:ncol(.))%>%
  mutate(date=as.Date(date),
         value=value/1000000)

ggplot(df, aes(x=date, y=value, color=valstybe, group=valstybe)) +
  geom_line(size=1.1)+
  scale_color_brewer(palette="Paired",type = "qualitative", name="Valstybės")+
  labs(
    title="Atvejų skaičius top 6-15 šalys, mln.",
    subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
    x="Laikotarpis",
    y="Užsikrėtimų skaičius"
  )+
  scale_x_date(breaks="1 month", date_labels = "%Y-%m")+
  theme(axis.text=element_text(size=8),
        axis.text.x=element_text(angle=45, hjust=1))
```


## Užsikrėtimai (abs)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="confirmed",
         date==max(.$date))%>%
  select (valstybe, value)%>%
  top_n(.,20,value)%>%
  mutate(value=round(value/100000,1))

ggplot(df,aes(x=reorder(valstybe,-value), y=value)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Užsikrėtimų skaičius", 
       title=paste0("Užsikrėtimų skaičius (100 tūkst.), top 20 valstybių ", max.date),
       subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))

```

## Užsikrėtimai (abs, d/d)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="confirmed",
         date==max(.$date)-1|date==max(.$date))%>%
  spread(date, value)%>%
  mutate(value=.[,6]-.[,5])%>%
  select (valstybe, value)%>%
  top_n(.,20,value)

ggplot(df,aes(x=reorder(valstybe,-value), y=value)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Užsikrėtimų skaičius", 
       title=paste0("Užsikrėtimų skaičius per paskutinę parą, top 20 valstybių, ", max.date),
       subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))

```

## Užsikrėtimai (/pop)
```{r, echo=FALSE}
max.date<-max(data_world$date)
pop_world <- data.frame(SOVEREIGNT=shape$SOVEREIGNT, POP_EST=shape$POP_EST, stringsAsFactors = FALSE)

df <- data_world %>%
  filter(var=="confirmed",
         date==max(.$date))%>%
  left_join(., pop_world, by=c("country"="SOVEREIGNT"))%>%
  mutate(value_pop=round(value/POP_EST*1000,1))%>%
  top_n(.,20,value_pop)

ggplot(df,aes(x=reorder(valstybe,-value_pop), y=value_pop)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value_pop, y=value_pop), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Užsikrėtimų skaičius", 
       title=paste0("Užsikrėtimų skaičius tenkantis 1 tūkst. gyventojų ( ", max.date, " duomenimis)"),
       subtitle="Šaltinis: JHCSSE, Skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))
```

## Užsikrėtimai (proc. d/d)

```{r, echo=FALSE}
max.date<-max(data_world$date)

df <- data_world %>%
  filter(var=="confirmed")%>%
  filter(date==max.date-1|date==max.date,
         value>=1)%>%
  spread(date, value)%>%
  mutate(value=round((.[,6]/.[,5]-1)*100,1))%>%
  top_n(.,20,value)

ggplot(df,aes(x=reorder(valstybe,-value), y=value)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(title=paste0("Užsikrėtimų per paskutinę parą pokytis, %, ", max.date),
       subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
       x="Valstybė", 
       y="proc. pokytis")+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))
```

## Užsikrėtimai (ts, top 6)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="confirmed")%>%
  spread(date, value)%>%
  arrange(desc(.[,ncol(.)]))%>%
  .[1:6,]%>%
  gather(date, value, 5:ncol(.))%>%
  group_by(valstybe) %>%
  mutate(diff = value - lag(value, default = first(value)))%>%
  mutate(date=as.Date(date))

max.date<-max(df$date)

ggplot(df, aes(x=date, y=diff)) +
  geom_area()+
  scale_x_date(breaks="1 month", date_labels = "%Y-%m")
labs(title=paste0('Dieninis naujų užsikrėtimų skaičius skaičius (top 6 pagal skaičių), ',max.date),
     subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
     x="Data",
     y="Skaičius") +
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  facet_wrap(~valstybe, ncol=3, 
             nrow = 2, 
             scales='free')   

```

## Mirtys (abs)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="deaths",
         date==max(.$date))%>%
  select (valstybe, value)%>%
  top_n(.,20,value)

ggplot(df,aes(x=reorder(valstybe,-value), y=value)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Mirčių skaičius", 
       title=paste0("Mirčių skaičius, top 20 valstybių, ", max.date),
       subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))

```

## Mirtys (abs, d/d)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="deaths")%>%
  filter(date==max(.$date)-1|date==max(.$date))%>%
  spread(date, value)%>%
  mutate(value=.[,6]-.[,5])%>%
  select (valstybe, value)%>%
  top_n(.,20,value)

ggplot(df,aes(x=reorder(valstybe,-value), y=value)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Užsikrėtimų skaičius", 
       title=paste0("Mirčių skaičius per paskutinę parą, ", max.date),
       subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))

```

## Mirtys (/pop)
```{r, echo=FALSE}
max.date<-max(data_world$date)
pop_world <- data.frame(SOVEREIGNT=shape$SOVEREIGNT, POP_EST=shape$POP_EST, stringsAsFactors = FALSE)

df <- data_world %>%
  filter(var=="deaths",
         date==max(.$date))%>%
  left_join(., pop_world, by=c("country"="SOVEREIGNT"))%>%
  mutate(value_pop=round(value/POP_EST*100000,1))%>%
  top_n(.,20,value_pop)

ggplot(df,aes(x=reorder(valstybe,-value_pop), y=value_pop)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value_pop, y=value_pop), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Mirčių skaičius", 
       title=paste0("Mirčių skaičius tenkantis 100 000 gyventojų ( ", max.date, " duomenimis)"),
       subtitle="Šaltinis: JHCSSE, Skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))
```


## Mirtingumas (top 20)

```{r,echo=FALSE}
df <- data_world %>%
  filter(var%in%c("deaths","confirmed"),
         date==max(date))%>%
  spread(var,value)%>%
  mutate(deathrate=deaths/confirmed*100)%>%
  mutate_at(vars(deathrate),funs(round(.,1)))%>%
  arrange(deathrate)%>%
  top_n(.,30, deathrate)

ggplot(df,aes(x=reorder(valstybe,-deathrate), y=deathrate, fill=valstybe))+
  geom_bar(stat='identity',
           fill="steelblue") +
  geom_text(aes(label=deathrate, y=deathrate), size=2.5, vjust=-0.5)+
  labs(x="Valstybė", 
       y="Mirtingumas, %", 
       title="Mirtingumas top 30 pasaulio šalių", 
       subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt" )+
  theme(legend.title=element_blank(),
        legend.position="",
        axis.text=element_text(size=8),
        axis.text.x=element_text(angle=45, hjust=1))

```

## Mirtys (ts, top 9)

```{r, echo=FALSE}
df <- data_world %>%
  filter(var=="deaths")%>%
  spread(date, value)%>%
  arrange(desc(.[,ncol(.)]))%>%
  .[1:9,]%>%
  gather(date, value, 5:ncol(.))%>%
  group_by(valstybe) %>%
  mutate(diff = value - lag(value, default = first(value)))%>%
  mutate(date=as.Date(date))

max.date<-max(df$date)

ggplot(df, aes(x=date, y=diff)) +
  geom_area()+
  scale_x_date(breaks="1 month", date_labels = "%Y-%m")
labs(title="Dieninis mirčių skaičius skaičius",
     subtitle="Šaltinis: JHCSSE, skaičiavimai: Corona-Stat.lt",
     x="Data",
     y="Skaičius") +
  theme(axis.text.x=element_text(angle=45, hjust=1))+
  facet_wrap(~valstybe, ncol=3, 
             nrow = 3, 
             scales='free_y')   

```